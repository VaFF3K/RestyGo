import React, { useEffect, useState } from 'react';
import { useLocation } from 'react-router-dom';
import {statusLabels} from "../../utils/statusMap";

function ProfilePage() {
    const location = useLocation();
    const [tab, setTab] = useState('active');
    const [orders, setOrders] = useState([]);

    useEffect(() => {
        const query = new URLSearchParams(location.search);
        const t = query.get('tab');
        if (t) setTab(t);
    }, [location]);

    useEffect(() => {
        fetch('http://localhost:8080/api/orders/my', {
            credentials: 'include'
        })
            .then(res => res.json())
            .then(setOrders)
            .catch(err => {
                console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –∑–∞–º–æ–≤–ª–µ–Ω—å:", err);
                setOrders([]);
            });
    }, []);

    const filteredOrders = orders.filter(order => {
        if (tab === 'active') {
            return order.status === 'NEW' || order.status === 'IN_PROGRESS';
        } else {
            return order.status === 'READY' || order.status === 'CANCELLED';
        }
    });

    const handleIssue = (orderId) => {
        if (!window.confirm("–í–∏ –¥—ñ–π—Å–Ω–æ —Ö–æ—á–µ—Ç–µ —Å–∫–∞—Å—É–≤–∞—Ç–∏ —Ü–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è?")) return;

        fetch(`http://localhost:8080/api/orders/${orderId}/issue`, {
            method: 'PUT',
            credentials: 'include'
        })
            .then(res => {
                if (!res.ok) {
                    return res.text().then(text => { throw new Error(text) });
                }
                return res.text();
            })
            .then(msg => {
                alert(msg);
                setOrders(prevOrders =>
                    prevOrders.map(o =>
                        o.id === orderId ? { ...o, status: 'CANCELLED' } : o
                    )
                );
            })
            .catch(err => {
                alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Å–∫–∞—Å—É–≤–∞–Ω–Ω—ñ: " + err.message);
            });
    };

    return (
        <div className="profile-container">
            <h2>–ú—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å</h2>

            <div className="profile-tabs">
                <button
                    onClick={() => setTab('active')}
                    className={tab === 'active' ? 'active' : ''}
                >
                    üïì –ê–∫—Ç–∏–≤–Ω—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
                </button>
                <button
                    onClick={() => setTab('history')}
                    className={tab === 'history' ? 'active' : ''}
                >
                    üìú –Ü—Å—Ç–æ—Ä—ñ—è
                </button>
            </div>

            {filteredOrders.length === 0 ? (
                <p>–ó–∞–º–æ–≤–ª–µ–Ω—å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.</p>
            ) : (
                <div className="orders-list">
                    {filteredOrders.map(order => {
                        const statusInfo = statusLabels[order.status] || { label: order.status, color: "#e2e3e5" };
                        return (
                        <div key={order.id} className="order-card">
                            <h3>–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è ‚Ññ{order.id}</h3>
                            <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span style={{
                                backgroundColor: statusInfo.color,
                                padding: '5px 10px',
                                borderRadius: '6px',
                                fontWeight: 'bold',
                                display: 'inline-block'
                            }}>{statusInfo.label} </span></p>
                            <p><strong>–ü–æ–∑–∏—Ü—ñ—ó –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è:</strong></p>
                            <ul>
                                {order.items.map((item, index) => (
                                    <li key={index}>
                                        {item.name} ({item.quantity} —à—Ç) ‚Äî {item.price * item.quantity} ‚Ç¥
                                    </li>
                                ))}
                            </ul>

                            {order.comment && (
                                <p><strong>–ö–æ–º–µ–Ω—Ç–∞—Ä –¥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:</strong> {order.comment}</p>
                            )}
                            <p><strong>–î–∞—Ç–∞ —ñ —á–∞—Å:</strong> {new Date(order.createdAt).toLocaleString('uk-UA')}</p>
                            <p><strong>–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞:</strong> {order.totalPrice ?? 0} ‚Ç¥</p>

                            {order.status === 'NEW' && (
                                <button
                                    className="cancel-button"
                                    onClick={() => handleIssue(order.id)}
                                >
                                    ‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
                                </button>
                            )}
                            {order.status === 'IN_PROGRESS' || order.status === 'READY' ? (
                                <p className="order-status-note">–í–∏ –±—ñ–ª—å—à–µ –Ω–µ –º–æ–∂–µ—Ç–µ —Å–∫–∞—Å—É–≤–∞—Ç–∏ —Ü–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</p>
                            ) : order.status === 'CANCELLED' ? (
                                <p className="order-status-note">–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —Å–∫–∞—Å–æ–≤–∞–Ω–æ</p>
                            ) : null}
                        </div> );
                    })}
                </div>
            )}
        </div>

    );
}

export default ProfilePage;
